(()=>{"use strict";const e="popup_is-opened",t="."+e,n="popup_is-animated";function r(){const e=document.querySelector(t);null!==e&&o(e)}function o(t){t.classList.contains("popup")&&t.classList.remove(e,n),document.removeEventListener("keydown",a)}function c(t){t.classList.add(n),setTimeout((()=>{t.classList.add(e)}),1),document.addEventListener("keydown",a)}function a(e){"Escape"===e.key&&r()}const s={baseUrl:"https://nomoreparties.co/v1/cohort-mag-3",headers:{authorization:"bbf4b680-493e-48d0-acc5-e0b3baeafed8","Content-Type":"application/json"}},l=e=>e.ok?e.json():Promise.reject(e),i=(e,t,n)=>{const r=n.errorElementSelector?n.errorElementSelector(t):`.${t.id}-error`,o=e.querySelector(r);o&&(t.classList.remove(n.inputErrorClass),o.textContent="",o.classList.remove(n.errorClass))},u=(e,t)=>{(e=>e.some((e=>!e.validity.valid)))(e)?t.disabled=!0:t.disabled=!1};function d(e,t){const n=Array.from(e.querySelectorAll(t.inputSelector)),r=e.querySelector(".popup__button");n.forEach((o=>{u(n,r),i(e,o,t)}))}const p=document.querySelector(".popup_type_image"),m=p.querySelector(".popup__image"),_=p.querySelector(".popup__caption"),y=document.querySelector(".profile__title"),f=document.querySelector(".profile__description"),h=document.querySelector(".profile__image"),b=document.forms["edit-profile"],S=document.querySelector(".profile__add-button"),v=document.querySelector(".profile__edit-button"),q=document.querySelector(".popup_type_edit"),C=document.forms["edit-avatar"],k=document.querySelector(".popup_type_avatar"),E=document.forms["new-place"],L=document.querySelector(".places__list"),g=document.querySelector(".popup_type_new-card");let w=null;const x={rmFunc:async function(e,t){try{const n=await function(e,t){const n=new Request(e.baseUrl+`/cards/${t}`);return fetch(n,{method:"DELETE",headers:e.headers}).then(l)}(s,t);console.log(n),e.remove()}catch(e){console.error("Ошибка удаления карточки:",e)}},likeFunc:async function(e,t,n,r){const o=e.querySelector(".card__like-button"),c=o.classList.contains("card__like-button_is-active");try{let e;e=c?await function(e,t){const n=new Request(e.baseUrl+`/cards/likes/${t}`),r={method:"DELETE",headers:e.headers};return fetch(n,r).then(l)}(r,t):await function(e,t){const n=new Request(e.baseUrl+`/cards/likes/${t}`),r={method:"PUT",headers:e.headers};return fetch(n,r).then(l)}(r,t),o.classList.toggle("card__like-button_is-active"),n(e.likes.length)}catch(e){console.error("Ошибка при работе с лайком:",e)}},handleImageClick:function(e,t,n){n.addEventListener("click",(()=>{m.src=e,m.alt=t,_.textContent=t,c(p)}))},apiConfig:s};function T(e,t,n,r,o,c,a,s,l="prepend"){const i=function(e,t,n,r,o,c,a,s){const l=document.querySelector("#card-template").content.querySelector(".card").cloneNode(!0),i=l.querySelector(".card__image");i.src=t,i.alt=e,l.querySelector(".card__title").textContent=e;const u=l.querySelector(".card__like-count");u.textContent=r,c.some((e=>e._id===o))&&l.querySelector(".card__like-button").classList.add("card__like-button_is-active"),a!==o&&(l.querySelector(".card__delete-button").style.display="none"),s.handleImageClick(t,e,i),l.querySelector(".card__delete-button").addEventListener("click",(()=>{s.rmFunc(l,n)}));const d=l.querySelector(".card__like-button"),p=e=>{u.textContent=e};return d.addEventListener("click",(()=>{s.likeFunc(l,n,p,s.apiConfig)})),l}(e,t,n,r,o,c,a,s);L[l](i)}Promise.all([function(e){const t=new Request(e.baseUrl+"/users/me");return fetch(t,{method:"GET",headers:e.headers}).then(l)}(s),function(e){const t=new Request(e.baseUrl+"/cards");return fetch(t,{method:"GET",headers:e.headers}).then(l)}(s)]).then((([e,t])=>{w=e._id,A(e),async function(e,t){e.forEach((e=>{T(e.name,e.link,e._id,e.likes.length,t,e.likes,e.owner._id,x,"append")}))}(t,w)})).catch((e=>{console.error("Ошибка при загрузке данных:",e)})),b.addEventListener("submit",(async function(e){e.preventDefault();const t=b.name.value,n=b.description.value,o=b.querySelector(".popup__button"),c=o.textContent;o.textContent="Сохранение...",o.disabled=!0;try{await async function(e,t){try{const n=await function(e,t,n){const r=new Request(e.baseUrl+"/users/me"),o={method:"PATCH",headers:e.headers,body:JSON.stringify({name:t,about:n})};return fetch(r,o).then(l)}(s,e,t);y.textContent=n.name,f.textContent=n.about}catch(e){console.error("Ошибка обновления профиля:",e)}}(t,n),r()}catch(e){console.error("Ошибка обновления профиля:",e)}finally{o.textContent=c,o.disabled=!1}})),v.addEventListener("click",(()=>{var e;d(b,U),(e=b).name.value=y.textContent,e.description.value=f.textContent,c(q)})),E.addEventListener("submit",(async function(e){e.preventDefault();const t=E["place-name"].value,n=E.link.value,o=E.querySelector(".popup__button"),c=o.textContent;o.textContent="Сохранение...",o.disabled=!0;try{const e=await function(e,t,n){const r=new Request(e.baseUrl+"/cards"),o={method:"POST",headers:e.headers,body:JSON.stringify({name:t,link:n})};return fetch(r,o).then(l)}(s,t,n);T(e.name,e.link,e._id,e.likes.length,w,e.likes,w,x),E.reset(),r()}catch(e){console.error("Ошибка при добавлении карточки:",e)}finally{o.textContent=c,o.disabled=!1}})),S.addEventListener("click",(()=>{d(E,U),c(g)})),h.addEventListener("click",(()=>{d(C,U),c(k)})),document.querySelectorAll(".popup").forEach((t=>{t.addEventListener("mousedown",(n=>{n.target.classList.contains("popup__close")&&o(t),n.target.classList.contains(e)&&o(t)}))})),C.addEventListener("submit",(async function(e){e.preventDefault();const t=C["avatar-link"].value,n=C.querySelector(".popup__button"),o=n.textContent;n.textContent="Сохранение...",n.disabled=!0;try{const e=await function(e,t){const n=new Request(e.baseUrl+"/users/me/avatar"),r={method:"PATCH",headers:e.headers,body:JSON.stringify({avatar:t})};return fetch(n,r).then(l)}(s,t);h.style.backgroundImage=`url('${e.avatar}')`,r()}catch(e){console.error("Ошибка обновления аватара:",e)}finally{n.textContent=o,n.disabled=!1}}));const U={formSelector:".popup__form",inputSelector:".popup__input",submitButtonSelector:".popup__button",inputErrorClass:"popup__input_type_error",errorClass:"popup__error_visible",errorElementSelector:e=>`.${e.id}-error`};!function(e){Array.from(document.querySelectorAll(e.formSelector)).forEach((t=>{!function(e,t){const n=Array.from(e.querySelectorAll(t.inputSelector)),r=e.querySelector(t.submitButtonSelector);n.forEach((o=>{o.addEventListener("input",(()=>{((e,t,n)=>{t.validity.patternMismatch?t.setCustomValidity(t.dataset.errorMessage):t.setCustomValidity(""),t.validity.valid?i(e,t,n):((e,t,n,r)=>{const o=r.errorElementSelector?r.errorElementSelector(t):`.${t.id}-error`,c=e.querySelector(o);t.classList.add(r.inputErrorClass),c.textContent=n,c.classList.add(r.errorClass)})(e,t,t.validationMessage,n)})(e,o,t),u(n,r)}))}))}(t,e)}))}(U);const A=function(e){y.textContent=e.name||"",f.textContent=e.about||"",h.style.backgroundImage=`url('${e.avatar}')`}})();