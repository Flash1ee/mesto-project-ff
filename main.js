(()=>{"use strict";const e="popup_is-opened",t="."+e,r="popup_is-animated";function o(){const e=document.querySelector(t);null!==e&&n(e)}function n(t){t.classList.contains("popup")&&t.classList.remove(e,r),document.removeEventListener("keydown",a)}function c(t){t.classList.add(r),setTimeout((()=>{t.classList.add(e)}),1),document.addEventListener("keydown",a)}function a(e){"Escape"===e.key&&o()}const s={baseUrl:"https://nomoreparties.co/v1/cohort-mag-3",headers:{authorization:"bbf4b680-493e-48d0-acc5-e0b3baeafed8","Content-Type":"application/json"}},l=(e,t,r)=>{const o=r.errorElementSelector?r.errorElementSelector(t):`.${t.id}-error`,n=e.querySelector(o);n&&(t.classList.remove(r.inputErrorClass),n.textContent="",n.classList.remove(r.errorClass))};function i(e,t){Array.from(e.querySelectorAll(t.inputSelector)).forEach((r=>{l(e,r,t)}))}const u=document.querySelector(".popup_type_image"),d=u.querySelector(".popup__image"),p=u.querySelector(".popup__caption"),m=document.querySelector(".profile__title"),h=document.querySelector(".profile__description"),_=document.querySelector(".profile__image"),y=document.forms["edit-profile"],f=document.querySelector(".profile__add-button"),E=document.querySelector(".profile__edit-button"),v=document.querySelector(".popup_type_edit"),S=document.forms["edit-avatar"],b=document.querySelector(".popup_type_avatar"),k=document.forms["new-place"],q=document.querySelector(".places__list"),g=document.querySelector(".popup_type_new-card");let C=null;const L={rmFunc:async function(e,t){try{const r=await function(e,t){const r=new Request(e.baseUrl+`/cards/${t}`);return fetch(r,{method:"DELETE",headers:e.headers}).then((e=>e.ok?e.json():Promise.reject(`Error on delete card: ${e.status}`))).catch((e=>{console.log("Error on delete card: ",e)}))}(s,t);console.log(r),e.remove()}catch(e){console.error("Ошибка удаления карточки:",e)}},likeFunc:async function(e,t,r,o){const n=e.querySelector(".card__like-button"),c=n.classList.contains("card__like-button_is-active");try{let e;e=c?await function(e,t){const r=new Request(e.baseUrl+`/cards/likes/${t}`),o={method:"DELETE",headers:e.headers};return fetch(r,o).then((e=>e.ok?e.json():Promise.reject(`Error on delete like: ${e.status}`))).then((e=>e)).catch((e=>{console.log("Error on delete like: ",e)}))}(o,t):await function(e,t){const r=new Request(e.baseUrl+`/cards/likes/${t}`),o={method:"PUT",headers:e.headers};return fetch(r,o).then((e=>e.ok?e.json():Promise.reject(`Error on add like: ${e.status}`))).then((e=>e)).catch((e=>{console.log("Error on add like: ",e)}))}(o,t),n.classList.toggle("card__like-button_is-active"),r(e.likes.length)}catch(e){console.error("Ошибка при работе с лайком:",e)}},handleImageClick:function(e,t,r){r.addEventListener("click",(()=>{d.src=e,d.alt=t,p.textContent=t,c(u)}))},apiConfig:s};function w(e,t,r,o,n,c,a,s,l="prepend"){const i=function(e,t,r,o,n,c,a,s){const l=document.querySelector("#card-template").content.querySelector(".card").cloneNode(!0),i=l.querySelector(".card__image");i.src=t,i.alt=e,l.querySelector(".card__title").textContent=e;const u=l.querySelector(".card__like-count");u.textContent=o,c.some((e=>e._id===n))&&l.querySelector(".card__like-button").classList.add("card__like-button_is-active"),a!==n&&(l.querySelector(".card__delete-button").style.display="none"),s.handleImageClick(t,e,i),l.querySelector(".card__delete-button").addEventListener("click",(()=>{s.rmFunc(l,r)}));const d=l.querySelector(".card__like-button"),p=e=>{u.textContent=e};return d.addEventListener("click",(()=>{s.likeFunc(l,r,p,s.apiConfig)})),l}(e,t,r,o,n,c,a,s);q[l](i)}Promise.all([function(e){const t=new Request(e.baseUrl+"/users/me");return fetch(t,{method:"GET",headers:e.headers}).then((e=>e.ok?e.json():Promise.reject(`Error on get user data: ${e.status}`))).then((e=>e)).catch((e=>{console.log("Error on get user data: ",e)}))}(s),function(e){const t=new Request(e.baseUrl+"/cards");return fetch(t,{method:"GET",headers:e.headers}).then((e=>e.ok?e.json():Promise.reject(`Error on edit user data: ${e.status}`))).then((e=>e)).catch((e=>{console.log("Error on get user data: ",e)}))}(s)]).then((([e,t])=>{C=e._id,j(e),async function(e,t){e.forEach((e=>{w(e.name,e.link,e._id,e.likes.length,t,e.likes,e.owner._id,L,"append")}))}(t,C)})).catch((e=>{console.error("Ошибка при загрузке данных:",e)})),y.addEventListener("submit",(async function(e){e.preventDefault();const t=y.name.value,r=y.description.value,n=y.querySelector(".popup__button"),c=n.textContent;n.textContent="Сохранение...",n.disabled=!0;try{await async function(e,t){try{const r=await function(e,t,r){const o=new Request(e.baseUrl+"/users/me"),n={method:"PATCH",headers:e.headers,body:JSON.stringify({name:t,about:r})};return fetch(o,n).then((e=>e.ok?e.json():Promise.reject(`Error on edit user data: ${e.status}`))).then((e=>e)).catch((e=>{console.log("Error on get user data: ",e)}))}(s,e,t);m.textContent=r.name,h.textContent=r.about}catch(e){console.error("Ошибка обновления профиля:",e)}}(t,r)}catch(e){console.error("Ошибка обновления профиля:",e)}finally{n.textContent=c,n.disabled=!1,o()}})),E.addEventListener("click",(()=>{var e;i(y,x),(e=y).name.value=m.textContent,e.description.value=h.textContent,c(v)})),k.addEventListener("submit",(async function(e){e.preventDefault();const t=k["place-name"].value,r=k.link.value;try{const e=await function(e,t,r){const o=new Request(e.baseUrl+"/cards"),n={method:"POST",headers:e.headers,body:JSON.stringify({name:t,link:r})};return fetch(o,n).then((e=>e.ok?e.json():Promise.reject(`Error on add card: ${e.status}`))).then((e=>e)).catch((e=>{console.log("Error on add card: ",e)}))}(s,t,r);w(e.name,e.link,e._id,e.likes.length,C,e.likes,C,L),k.reset(),o()}catch(e){console.error("Ошибка при добавлении карточки:",e)}})),f.addEventListener("click",(()=>{i(k,x),c(g)})),_.addEventListener("click",(()=>{i(S,x),c(b)})),document.querySelectorAll(".popup").forEach((t=>{t.addEventListener("mousedown",(r=>{r.target.classList.contains("popup__close")&&n(t),r.target.classList.contains(e)&&n(t)}))})),S.addEventListener("submit",(async function(e){e.preventDefault();const t=S["avatar-link"].value,r=S.querySelector(".popup__button"),n=r.textContent;r.textContent="Сохранение...",r.disabled=!0;try{const e=await function(e,t){const r=new Request(e.baseUrl+"/users/me/avatar"),o={method:"PATCH",headers:e.headers,body:JSON.stringify({avatar:t})};return fetch(r,o).then((e=>e.ok?e.json():Promise.reject(`Error on update avatar: ${e.status}`))).then((e=>e)).catch((e=>{console.log("Error on update avatar: ",e)}))}(s,t);_.style.backgroundImage=`url('${e.avatar}')`}catch(e){console.error("Ошибка обновления аватара:",e)}finally{r.textContent=n,r.disabled=!1,o()}}));const x={formSelector:".popup__form",inputSelector:".popup__input",submitButtonSelector:".popup__button",inputErrorClass:"popup__input_type_error",errorClass:"popup__error_visible",errorElementSelector:e=>`.${e.id}-error`};!function(e){Array.from(document.querySelectorAll(e.formSelector)).forEach((t=>{!function(e,t){const r=Array.from(e.querySelectorAll(t.inputSelector)),o=e.querySelector(t.submitButtonSelector);r.forEach((n=>{n.addEventListener("input",(()=>{((e,t,r)=>{t.validity.patternMismatch?t.setCustomValidity(t.dataset.errorMessage):t.setCustomValidity(""),t.validity.valid?l(e,t,r):((e,t,r,o)=>{const n=o.errorElementSelector?o.errorElementSelector(t):`.${t.id}-error`,c=e.querySelector(n);t.classList.add(o.inputErrorClass),c.textContent=r,c.classList.add(o.errorClass)})(e,t,t.validationMessage,r)})(e,n,t),((e,t)=>{(e=>e.some((e=>!e.validity.valid)))(e)?t.disabled=!0:t.disabled=!1})(r,o)}))}))}(t,e)}))}(x);const j=function(e){m.textContent=e.name||"",h.textContent=e.about||"",_.style.backgroundImage=`url('${e.avatar}')`}})();